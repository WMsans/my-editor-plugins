<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation Node</title>
    <style>
      :root { 
        /* Default / Fallback (Dark) */
        --bg: #181825; 
        --header: #313244; 
        --text: #cdd6f4; 
        --accent: #89b4fa; 
        --error: #f38ba8; 
        --border: #45475a;
        --input-bg: #11111b;
        --input-text: #a6e3a1;
      }
      body { margin: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: sans-serif; }
      .sim-container { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
      .header { 
        background: var(--header); padding: 6px 10px; 
        display: flex; justify-content: space-between; align-items: center; 
        font-size: 0.8rem; font-weight: bold; border-bottom: 1px solid var(--border);
      }
      button { 
        background: var(--accent); color: var(--bg); border: none; 
        padding: 4px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; 
      }
      button:hover { opacity: 0.9; }
      .body { display: flex; flex: 1; min-height: 0; }
      textarea { 
        flex: 1; background: var(--input-bg); color: var(--input-text); border: none; 
        padding: 10px; resize: none; outline: none; font-family: monospace; 
      }
      .canvas-box { 
        flex: 1; background: #000; position: relative; 
        display: flex; align-items: center; justify-content: center; 
      }
      .error-toast { 
        position: absolute; bottom: 0; left: 0; right: 0; 
        background: rgba(243, 139, 168, 0.9); color: #1e1e2e; 
        padding: 5px; font-size: 0.75rem; display: none; 
      }
    </style>
    <script>
        function syncTheme() {
            try {
                const p = window.parent.document.documentElement;
                const s = window.parent.getComputedStyle(p);
                const r = document.documentElement.style;
                
                r.setProperty('--bg', s.getPropertyValue('--bg-secondary'));
                r.setProperty('--header', s.getPropertyValue('--bg-tertiary'));
                r.setProperty('--text', s.getPropertyValue('--text-primary'));
                r.setProperty('--accent', s.getPropertyValue('--accent'));
                r.setProperty('--border', s.getPropertyValue('--border-color'));
                r.setProperty('--input-bg', s.getPropertyValue('--bg-primary'));
                r.setProperty('--input-text', s.getPropertyValue('--hl-string'));
            } catch(e) {}
        }
        syncTheme();
    </script>
</head>
<body>
    <div class="sim-container">
      <div class="header">
        <span class="title">üñ•Ô∏è Simulation Node (Worker)</span>
        <button id="run-btn">‚ñ∂ Run</button>
      </div>
      <div class="body">
        <textarea id="editor" spellcheck="false" placeholder="// Write JS here..."></textarea>
        <div class="canvas-box">
          <canvas id="canvas" width="300" height="200"></canvas>
          <div id="error" class="error-toast"></div>
        </div>
      </div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const runBtn = document.getElementById('run-btn');
        const canvas = document.getElementById('canvas');
        const errorBox = document.getElementById('error');
        
        let nodeId = null;

        // Default Code
        const DEFAULT_CODE = "// Draw something cool\nconst ctx = canvas.getContext('2d');\nctx.fillStyle = '#89b4fa';\nctx.fillRect(50, 50, 100, 100);";

        // Initialize with default
        editor.value = DEFAULT_CODE;

        // --- Communication with Host ---
        
        // 1. Listen for data from the main thread
        window.addEventListener('message', (e) => {
           // The Host sends 'SYNC_ATTRS' when the block loads or updates
           if (e.data && e.data.type === 'SYNC_ATTRS') {
               const attrs = e.data.attrs;
               nodeId = attrs.id; // Capture the Node ID so we can send updates back
               
               const newCode = attrs.code;
               if (newCode !== undefined && newCode !== null && editor.value !== newCode) {
                   editor.value = newCode;
               }
           }
        });

        // 2. Send updates to the main thread
        editor.addEventListener('input', () => {
          if (nodeId) {
            window.parent.postMessage({ 
                type: 'UPDATE_ATTRS', 
                nodeId: nodeId, 
                attrs: { code: editor.value } 
            }, '*');
          }
        });

        // --- Simulation Logic ---

        const runSimulation = () => {
          const code = editor.value;
          errorBox.style.display = 'none';
          canvas.width = canvas.width; // Clear/Reset canvas

          try {
            const func = new Function("canvas", "console", code);
            func(canvas, { 
              log: (...args) => console.log('[Sim]', ...args) 
            });
          } catch (e) {
            errorBox.textContent = e.toString();
            errorBox.style.display = 'block';
          }
        };

        runBtn.addEventListener('click', runSimulation);

        // Hotkeys (Ctrl+Enter to Run)
        editor.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            runSimulation();
          }
        });
    </script>
</body>
</html>